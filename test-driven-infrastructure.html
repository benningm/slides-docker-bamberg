<!DOCTYPE html>
<html>
  <head>
    <title>Test-Driven Infrastructure</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: 400;
        margin-bottom: 0;
      }
      .remark-slide-content h1 { font-size: 3em; }
      .remark-slide-content h2 { font-size: 2em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .footnote {
        position: absolute;
        bottom: 3em;
      }
      pre.console {
        background: #002b36;
        border-radius: 5px;
        font-family: 'Ubuntu Mono';
        color: #fdf6e3;
      }
      code {
        background: #e7e8e2;
        border-radius: 5px;
      }
      div.truncated-top code,div.truncated-top pre.console {
        border-top: 2px dashed #859900;
        border-top-left-radius: 0px;
        border-top-right-radius: 0px;
      }
      div.truncated-bottom code,div.truncated-bottom pre.console {
        border-bottom: 2px dashed #859900;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-code-line-highlighted     { background-color: #373832; }
      li p { line-height: 1.25em; }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      /* Two-column layout */
      .left-column {
        color: #777;
        width: 20%;
        height: 92%;
        float: left;
      }
      .left-column h2:last-of-type, .left-column h3:last-child {
        color: #000;
      }
      .right-column {
        width: 75%;
        float: right;
        /*padding-top: 1em; */
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Test-Driven Infrastructure

with Puppet, Cucumber and Docker

*Markus Benning*

---
layout: false
.left-column[
# Agenda
]
.right-column[
## Concepts

* Puppet
* Test-Driven Infrastructure
* Behavior-Driven Development

## Toolchain

* A toolchain for TDI

## Hands on 

* Build a simple webserver for serving a Docker Bamberg weblog

## Goodies

* Continuous Integration, Monitoring, Documentation, Checklists, Change Evidence build in!
]
---
class: center, middle
# Puppet
---
layout: false
.left-column[
  # Puppet
  ## What is it?
]
.right-column[
# Task: install Postfix (easy?)

Is it already installed?

```bash
$ dpkg -l postfix
```

No? Install version 3.1:

```bash
$ apt-get install postfix=3.1
```

Hum. That was for Debian, but on RedHat?

```bash
$ rpm -q postfix
$ yum install postfix=3.1
```
]

---

layout: false
.left-column[
  # Puppet
  ## What is it?
]
.right-column[
# With puppet

Write a manifest.pp file:

```puppet
package { 'postfix':
  ensure => '3.1',
}
```

then apply it:

```shell
$ puppet apply manifest.pp
```

]
---
class: center, middle
## Puppet turns config into code!
---
layout: false
.left-column[
  # Puppet
  ## What is it?
  ## Why use it?
]
.right-column[
# Turning config into code

What we get:

 * Repeatability
 * Automation
 * Agility
 * Scalability
 * Reassurance
 * Disaster Recovery
]
---
class: center, middle
# Test-Driven Infrastructure
---
# Test-Driven Development Workflow
![Default-aligned image](media/tdd-workflow.svg)
---
# Test-Driven ~~Development~~ Infrastructure
![Default-aligned image](media/tdi-workflow.svg)
---
class: center, middle
# Behavior-Driven Development
---
# BDD with Cucumber

Tests are written in gherkin:

```gherkin
Feature: Calculator
  The calculator must be able to calculate a simple addition.

  Scenario: Add a value to the buffer
    Given a new calculator instance is created
    When the buffer is set to 10
    And and the value 20 is added
    Then the buffer must be 30
```

.footnote[Cucumber Website: [Gherkin Reference](https://cucumber.io/docs/reference)]
---
# BDD with Cucumber (extended example)

```gherkin
Feature: Calculator
  The calculator must be able to calculate a simple addition.

  Scenario: Add a value to the buffer
    Given a new calculator instance is created
    When the buffer is set to <buffer>
    And and the value <value> is added
    Then the buffer must be <result>

    Examples:
    | buffer | value | result |
    | 10 | 20 | 30 |
    | 23 | 65 | 88 |
```
.footnote[Cucumber Website: [Gherkin Reference](https://cucumber.io/docs/reference)]
---
# BDD with Cucumber (no steps defined)

Execute the tests with `pherkin`:

```shell
$ pherkin features/addition.feature
```

The steps (tests) are uninplemented:

&lt;pre class=&quot;console&quot;&gt;

  Calculator
    The calculator must be able to calculate a simple addition.

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:yellow;&quot;&gt;Given a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 10&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And and the value 20 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 30&lt;/span&gt;

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:yellow;&quot;&gt;Given a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 23&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And and the value 65 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 88&lt;/span&gt;

&lt;/pre&gt;
---
# BDD with Cucumber (implement tests)

```perl
Given qr/^a new calculator instance is created$/, sub {
  use_ok('MyCalc');
  my $calc = MyCalc->new;
  isa_ok($calc, 'MyCalc');
  S->{'calc'} = $calc;
};

When qr/^the buffer is set to (\d+)$/, sub {
  S->{'calc'}->buffer($1);
};

When qr/^the value (\d+) is added$/, sub {
  S->{'calc'}->add($1);
};

Then qr/^the buffer must be (\d+)$/, sub {
  cmp_ok( S->{'calc'}->buffer, '==', $1, 'value of buffer must match');
};
```
.footnote[MetaCPAN: [Test:BDD:Cucumber](https://metacpan.org/release/Test-BDD-Cucumber), [Tutorial](https://metacpan.org/pod/distribution/Test-BDD-Cucumber/lib/Test/BDD/Cucumber/Manual/Tutorial.pod)]
---
# BDD with Cucumber (tests fail)

&lt;pre class=&quot;console&quot;&gt;

  Calculator
    The calculator must be able to calculate a simple addition.

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:red;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:red;&quot;&gt;a new calculator instance is created&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;step defined at features/addition.feature line 5.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;ok 1 - Starting to execute step: a new calculator instance is created&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;not ok 2 - use MyCalc;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   Failed test &#39;use MyCalc;&#39;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   at features/step_definitions/calc_steps.pl line 10.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#     Tried to use &#39;MyCalc&#39;.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#     Error:  Can&#39;t locate MyCalc.pm in @INC (you may need to install the MyCalc module) (@INC contains: /etc/perl /usr/local/lib/x86_64-linux-gnu/perl/5.22.1 /usr/local/share/perl/5.22.1 /usr/lib/x86_64-linux-gnu/perl5/5.22 /usr/share/perl5 /usr/lib/x86_64-linux-gnu/perl/5.22 /usr/share/perl/5.22 /usr/local/lib/site_perl /usr/lib/x86_64-linux-gnu/perl-base .) at features/step_definitions/calc_steps.pl line 10, &amp;lt;DATA&amp;gt; line 870.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;# BEGIN failed--compilation aborted at features/step_definitions/calc_steps.pl line 10, &amp;lt;DATA&amp;gt; line 870.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;not ok 3 - Test compiled&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   Failed test &#39;Test compiled&#39;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   at /usr/share/perl5/Test/BDD/Cucumber/Executor.pm line 419.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;# Can&#39;t locate object method &amp;quot;new&amp;quot; via package &amp;quot;MyCalc&amp;quot; (perhaps you forgot to load &amp;quot;MyCalc&amp;quot;?) at features/step_definitions/calc_steps.pl line 11, &amp;lt;DATA&amp;gt; line 870.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;1..3&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 10&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And the value 20 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 30&lt;/span&gt;

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:yellow;&quot;&gt;Given a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 23&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And the value 65 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 88&lt;/span&gt;

&lt;/pre&gt;
---
# BDD with Cucumber (implementation)

Implement the calculator class in perl:

```perl
package MyCalc;

use Moose;

has 'buffer' => ( is => 'rw', isa => 'Num', default => 0 );

sub add {
  my ( $self, $value ) = @_;
  return $self->buffer( $self->buffer + $value );
}

1;
```
---
# BDD with Cucumber (tests pass!)

&lt;pre class=&quot;console&quot;&gt;

  Calculator
    The calculator must be able to calculate a simple addition.

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;When &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer is set to &lt;/span&gt;10
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the value &lt;/span&gt;20&lt;span style=&quot;color:lime;&quot;&gt; is added&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer must be &lt;/span&gt;30

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;When &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer is set to &lt;/span&gt;23
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the value &lt;/span&gt;65&lt;span style=&quot;color:lime;&quot;&gt; is added&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer must be &lt;/span&gt;88

&lt;/pre&gt;
---
# BDD with Cucumber (why?)

* With BDD we get an **executable specification** which could be used for
all kind of **automated testing**.

* It is writte in gherkin a (near) **human language** everyone involved
should be able to understand.

* Therefor it could be used as a **single point of truth** across Devs,
Ops and Customers to **collaboratively work** on.

* Every change starts (red state) and ends (green state)
with the test specification. This keeps the **specification up to date**.
---
class: center, middle
# The Toolchain
---
# The Toolchain

## Environment

* **Docker** to provide a virtual environment
* The `benningm/puppet-base` image. Debian environment with our toolchain

## Configuration

* **Puppet** to apply configuration as defined in manifests
* **librarian-puppet** to install our puppet module and its dependecies

## Testing

* **Test::BDD::Cucumber** a perl implementation of Cucumber
* **Test::BDD::Infrastructure** collection of step definitions for TDI
* **T:B:C:Harness::Html** to generate HTML test reports
* **T:B:C:Harness::Nagios** to execute tests for nagios
---
class: center, middle
# Hands on
Build a simple weblog webserver
---
# Create an empty puppet module

Puppet has command for generating a module skeleton:

```shell
$ puppet module generate benningm-docker_bamberg
```

Push it to your git repository server:

```shell
$ cd benningm-docker_bamberg
$ git init
$ git add .
$ git commit -a -m 'check in of empty module skeleton'
$ git remote add origin git@github.com:benningm/puppet-docker_bamberg.git
$ git push -u origin master
```

The main class of your puppet module is defined in `manifests/init.pp`.
Edit the description and documentation in this file and commit it:

```shell
$ git commit -a -m 'add description and usage of module'
```
.footnote[
`benningm/puppet-docker_bamberg`:
[4c1d0d6](https://github.com/benningm/puppet-docker_bamberg/commit/4c1d0d6369db5bfe501ae061bfe0769c468a6907)
, [6c89882](https://github.com/benningm/puppet-docker_bamberg/commit/6c89882f1186ae14558cc505cd93cab2b647e8e1)
]
---
# Build the docker image (Dockerfile)

Fetch our puppet module and apply the its configuration:

```Dockerfile
FROM benningm/puppet-base:latest
MAINTAINER Markus Benning <ich@markusbenning.de>

ADD Puppetfile /etc/puppet/Puppetfile
RUN cd /etc/puppet && librarian-puppet install --verbose

ADD manifest.pp /etc/puppet/manifests/docker_bamberg.pp
RUN /usr/local/bin/puppet-apply-wrapper /etc/puppet/manifests

EXPOSE 80
```
The `puppet-apply-wrapper` script is just a wrapper around `puppet apply`
with correct return values to indicate failure/success.

We still have to create `Puppetfile` which configures `librarian-puppet`
and `manifest.pp` for puppet.
.footnote[
`benningm/docker-docker-bamberg`:
[40a1dae](https://github.com/benningm/docker-docker-bamberg/commit/40a1daeba7dc0c93a04ceccf40f47cfa33537d83)
]
---
# Build the docker image (Puppetfile)

```Puppetfile
forge "https://forgeapi.puppetlabs.com"

mod "benningm/docker_bamberg",
  :git => "https://github.com/benningm/puppet-docker_bamberg.git"

```

The first line tells `librarian-puppet` to fetch dependecies from the
Puppet Forge.

The second line installs our puppet module from our git repository.
---
# Build the docker image (manifest.pp)

```puppet
class { 'docker_bamberg':
}
```
The `manifest.pp` file just tells puppet to execute the class of our
module which has no parameters.

Create a git repository and push everything to your repository server.

---
# Build the docker image (do it!)

To build the docker image:

```shell
$ docker built -t docker-bamberg .
```

And start a container of it:

```shell
$ docker run -it --rm docker-bamberg /bin/bash
```

&lt;pre class=&quot;console&quot;&gt;
Notice: Compiled catalog for 3e6c1f1c68d9.lan in environment production in 0.01 seconds
Notice: Finished catalog run in 0.01 seconds
root@3e6c1f1c68d9:/# ps axf
  PID TTY      STAT   TIME COMMAND
    1 ?        Ss     0:00 /bin/bash /entrypoint.sh /bin/bash
  114 ?        S      0:00 /bin/bash
  119 ?        R+     0:00  \_ ps axf
root@3e6c1f1c68d9:/# exit
[ &lt;span style=&quot;color:lime;&quot;&gt;ok&lt;/span&gt; ] Asking all remaining processes to terminate...done.
[ &lt;span style=&quot;color:lime;&quot;&gt;ok&lt;/span&gt; ] All processes ended within 1 seconds...done.
&lt;/pre&gt;
---
# Start a development container

Now we start a container for development. We mount our local git directory
as a volume into the container. This way we can edit the puppet module
with our favorite editor and all tools available on our development box
and apply the changes within the container.

```shell
$ docker run -it --rm \
  --hostname docker-bamberg.de \
  -v ~/development/puppet-docker_bamberg:/etc/puppet/modules/docker_bamberg \
  docker-bamberg /bin/bash
```

&lt;pre class=&quot;console&quot;&gt;
Notice: Compiled catalog for docker-bamberg.de in environment production in 0.02 seconds
Notice: Finished catalog run in 0.09 seconds
root@docker-bamberg:/#
&lt;/pre&gt;

Everytime we change something we can apply the changes with:

```shell
root@docker-bamberg:/# puppet apply /etc/puppet/manifests/
```

&lt;pre class=&quot;console&quot;&gt;
Notice: Compiled catalog for docker-bamberg.de in environment production in 0.02 seconds
Notice: Finished catalog run in 0.06 seconds
&lt;/pre&gt;
---
# Define our mission goal

Befor we start with configuration details we want to specify what
we want to achieve.

Create a first feature `features/website.feature`:

```gherkin
Feature: Docker Bamberg website
  The Docker Bamberg needs a website to publish presentations and
  content on the internet.

  Scenario: The Website must be accessible
    Given the http URL http://docker-bamberg.de/
    Given the http request method is GET
    When the http request is sent
    Then the http response must be successfull
    And the http response content must be like Docker Bamberg
```
.footnote[
`benningm/puppet-docker_bamberg`:
[8cdf38a](https://github.com/benningm/puppet-docker_bamberg/commit/8cdf38a9990b3e1c0292739a03a659253fbcd795)
]
---
# Define our mission goal

To load the Test::BDD::Infrastructure step definitions.
Create `features/step_definitions/00use_steps.pl`:

```perl
#!perl
use Test::BDD::Infrastructure;
```
---
# Execute specification

```shell
root@docker-bamberg:/# pherkin /etc/puppet/modules/docker_bamberg/features/website.feature 
```

&lt;pre class=&quot;console&quot;&gt;
  Docker Bamberg website
    The Docker Bamberg needs a website to publish presentations and
    content on the internet.

    Scenario: The Website must be accessible
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http URL &lt;/span&gt;http://docker-bamberg.de/
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http request method is &lt;/span&gt;GET
      &lt;span style=&quot;color:lime;&quot;&gt;When &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http request is sent&lt;/span&gt;
      &lt;span style=&quot;color:red;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:red;&quot;&gt;the http response must be &lt;/span&gt;successfull
        &lt;span style=&quot;color:red;&quot;&gt;step defined at /etc/puppet/modules/docker_bamberg/features/website.feature line 9.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;ok 1 - Starting to execute step: the http response must be successfull&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;# response code is 500 Can&#39;t connect to docker-bamberg.de:80&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;not ok 2 - successfull http response&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   Failed test &#39;successfull http response&#39;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   at /usr/share/perl5/Test/BDD/Infrastructure/HTTP.pm line 67.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;1..2&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And the http response content must be like Docker Bamberg&lt;/span&gt;
&lt;/pre&gt;
---
# Deployment of the content

So we write a specification `features/content.feature` for that:

.truncated-bottom[
```gherkin
Feature: Webcontent for the Docker Bamberg website
  The Webcontent of the Docker Bamberg website is maintained
  in a git repository and built with jekyll.

  The git repository must be cloned and the website must be
  generated with jekyll.

  The repository clone is located at `/data/repo` and
  the generated website content at `/data/htdocs`.

  Scenario: Local clone of the git repository must exist
    Given the directory /data/repo exists
    Then the file type must be directory
    And the directory must contain a file like _config.yml
    And the directory must contain a file like index.html
    And the directory must contain a file like feed.xml
    And the directory must contain a file like .git
```
]
.footnote[
`benningm/puppet-docker_bamberg`:
[7ff9a81](https://github.com/benningm/puppet-docker_bamberg/commit/7ff9a816ef939b37a766faaf28535b11d8e31ff8)
]
---
# Deployment of the content

.truncated-top[
```gherkin
  Scenario: A generated copy of the website must exist
    Given the directory /data/htdocs exists
    Then the file type must be directory
    And the directory must contain a file like feed.xml
    And the directory must contain a file like index.html
    Given the file /data/htdocs/index.html exists
    Then the files content must match Docker Bamberg
```
]
---
# Deployment of the content
And again test results are red:

&lt;pre class=&quot;console&quot;&gt;
  Webcontent for the Docker Bamberg website
    The Webcontent of the Docker Bamberg website is maintained
    in a git repository and built with jekyll.
    The git repository must be cloned and the website must be
    generated with jekyll.
    The repository clone is located at `/data/repo` and
    the generated website content at `/data/htdocs`.

    Scenario: Local clone of the git repository must exist
      &lt;span style=&quot;color:red;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:red;&quot;&gt;the directory &lt;/span&gt;/data/repo&lt;span style=&quot;color:red;&quot;&gt; exists&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;step defined at /etc/puppet/modules/docker_bamberg/features/content.feature line 12.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;ok 1 - Starting to execute step: the directory /data/repo exists&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;not ok 2 - the file /data/repo does not exist&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   Failed test &#39;the file /data/repo does not exist&#39;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   at /usr/share/perl5/Test/BDD/Infrastructure/File.pm line 23.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;1..2&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the file type must be directory&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And the directory must contain a file like _config.yml&lt;/span&gt;
&lt;/pre&gt;
---
# Deployment of the content

Configure the deployment process in a puppet class `docker_bamberg::content` in `manifests/content.pp`:

.truncated-bottom[
```puppet
class docker_bamberg::content {
  package { 'jekyll':
    ensure  => present,
  }

  file { '/data' :
    ensure  => 'directory',
  } ->
  file { '/data/repo' :
    ensure  => 'directory',
  } ->
  file { '/data/htdocs' :
    ensure  => 'directory',
  } ->
```
]
---
# Deployment of the content
.truncated-top[
```puppet
  vcsrepo { '/data/repo':
    ensure     => 'latest',
    provider   => 'git',
    source     => 'https://github.com/benningm/jekyll-docker-bamberg.de.git',
  } ~>
  exec { "generate-content":
    command     => "jekyll build --destination /data/htdocs",
    cwd         => '/data/repo',
    path        => ["/bin", "/usr/bin"],
    refreshonly => 'true',
    creates     => '/data/htdocs/index.html',
    user        => 'root',
    require     => Package['jekyll'],
  }
}
```
]
---
# Deployment of the content

We must include the new class within our modules main class:

&lt;pre class=&quot;console&quot;&gt;
&lt;span style=&quot;font-weight:bold;&quot;&gt;--- a/manifests/init.pp&lt;/span&gt;
&lt;span style=&quot;font-weight:bold;&quot;&gt;+++ b/manifests/init.pp&lt;/span&gt;
&lt;span style=&quot;color:aqua;&quot;&gt;@@ -25,4 +25,5 @@&lt;/span&gt;
 # Copyright 2016 Markus Benning
 #
 class docker_bamberg {
&lt;span style=&quot;color:lime;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;  include docker_bamberg::content&lt;/span&gt;
 }
&lt;/pre&gt;

If we now apply our configuration we get the following error message:

&lt;pre class=&quot;console&quot;&gt;
&lt;span style=&quot;color:red;font-weight:bold;&quot;&gt;Error: Puppet::Parser::AST::Resource failed with error ArgumentError: Invalid resource type vcsrepo at /etc/puppet/modules/docker_bamberg/manifests/content.pp:19 on node docker-bamberg.de
Wrapped exception:
Invalid resource type vcsrepo&lt;/span&gt;
&lt;span style=&quot;color:red;font-weight:bold;&quot;&gt;Error: Puppet::Parser::AST::Resource failed with error ArgumentError: Invalid resource type vcsrepo at /etc/puppet/modules/docker_bamberg/manifests/content.pp:19 on node docker-bamberg.de&lt;/span&gt;
&lt;/pre&gt;
---
# Deployment of the content

The vcsrepo type we used is a extra puppet module we must depend on:

&lt;pre class=&quot;console&quot;&gt;
&lt;span style=&quot;font-weight:bold;&quot;&gt;--- a/metadata.json&lt;/span&gt;
&lt;span style=&quot;font-weight:bold;&quot;&gt;+++ b/metadata.json&lt;/span&gt;
&lt;span style=&quot;color:aqua;&quot;&gt;@@ -8,7 +8,8 @@&lt;/span&gt;
   &amp;quot;project_page&amp;quot;: &amp;quot;https://github.com/benningm/puppet-docker_bamberg&amp;quot;,
   &amp;quot;issues_url&amp;quot;: &amp;quot;https://github.com/benningm/puppet-docker_bamberg/issues&amp;quot;,
   &amp;quot;dependencies&amp;quot;: [
&lt;span style=&quot;color:red;&quot;&gt;-    {&amp;quot;name&amp;quot;:&amp;quot;puppetlabs-stdlib&amp;quot;,&amp;quot;version_requirement&amp;quot;:&amp;quot;&amp;gt;= 1.0.0&amp;quot;}&lt;/span&gt;
&lt;span style=&quot;color:lime;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;    {&amp;quot;name&amp;quot;:&amp;quot;puppetlabs-stdlib&amp;quot;,&amp;quot;version_requirement&amp;quot;:&amp;quot;&amp;gt;= 1.0.0&amp;quot;},&lt;/span&gt;
&lt;span style=&quot;color:lime;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;    {&amp;quot;name&amp;quot;:&amp;quot;puppetlabs-vcsrepo&amp;quot;,&amp;quot;version_requirement&amp;quot;:&amp;quot;&amp;gt;= 1.3.2&amp;quot;}&lt;/span&gt;
   ]
 }
&lt;/pre&gt;
---
# Deployment of the content
For now we just install the module with

```shell
root@docker-bamberg:~# puppet module install puppetlabs-vcsrepo
```

In the future `librarian-puppet` will do this for use, but in our case it also
would re-install our `docker_bamberg` module which still has uncommited changes!

If we now apply our configuration again and it works:

```shell
root@docker-bamberg:~# puppet apply /etc/puppet/manifests/
Notice: Compiled catalog for docker-bamberg.de in environment production in 0.27 seconds
Notice: /Stage[main]/Docker_bamberg::Content/File[/data]/ensure: created
Notice: /Stage[main]/Docker_bamberg::Content/Package[jekyll]/ensure: ensure changed 'purged' to 'present'
Notice: /Stage[main]/Docker_bamberg::Content/File[/data/repo]/ensure: created
Notice: /Stage[main]/Docker_bamberg::Content/File[/data/htdocs]/ensure: created
Notice: /Stage[main]/Docker_bamberg::Content/Vcsrepo[/data/repo]/ensure: Creating repository from latest
Notice: /Stage[main]/Docker_bamberg::Content/Vcsrepo[/data/repo]/ensure: created
Notice: /Stage[main]/Docker_bamberg::Content/Exec[generate-content]: Triggered 'refresh' from 1 events
Notice: Finished catalog run in 23.96 seconds
root@docker-bamberg:~# 
```
---
# Deployment of the content

Let's see what our tests say:

```shell
root@docker-bamberg:~# pherkin \
  /etc/puppet/modules/docker_bamberg/features/content.feature
```

.truncated-top[
&lt;pre class=&quot;console&quot;&gt;
    Scenario: Local clone of the git repository must exist
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the directory &lt;/span&gt;/data/repo&lt;span style=&quot;color:lime;&quot;&gt; exists&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the file type must be directory&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the directory must contain &lt;/span&gt;a&lt;span style=&quot;color:lime;&quot;&gt; file like &lt;/span&gt;_config.yml
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the directory must contain &lt;/span&gt;a&lt;span style=&quot;color:lime;&quot;&gt; file like &lt;/span&gt;index.html
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the directory must contain &lt;/span&gt;a&lt;span style=&quot;color:lime;&quot;&gt; file like &lt;/span&gt;feed.xml
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the directory must contain &lt;/span&gt;a&lt;span style=&quot;color:lime;&quot;&gt; file like &lt;/span&gt;.git

    Scenario: A generated copy of the website must exist
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the directory &lt;/span&gt;/data/htdocs&lt;span style=&quot;color:lime;&quot;&gt; exists&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the file type must be directory&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the directory must contain &lt;/span&gt;a&lt;span style=&quot;color:lime;&quot;&gt; file like &lt;/span&gt;feed.xml
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the directory must contain &lt;/span&gt;a&lt;span style=&quot;color:lime;&quot;&gt; file like &lt;/span&gt;index.html
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the file &lt;/span&gt;/data/htdocs/index.html&lt;span style=&quot;color:lime;&quot;&gt; exists&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the files content must &lt;/span&gt;match&lt;span style=&quot;color:lime;&quot;&gt; &lt;/span&gt;Docker Bamberg
&lt;/pre&gt;
]
---
# Webserver configuration

We still need a HTTP webserver to serve the static pages to the network:

```gherkin
Feature: Webserver for docker bamberg
  To serve the docker-bamberg.de website a webserver is required.
  The nginx webserver will be used.

  Scenario: nginx webserver must running
    Given a parent process like ^nginx: is running
    Then the uid of the process must be root
    Then the gid of the process must be root
    When there are at least 1 child processes
    Then the uid of the child processes must be www-data
    Then the gid of the child processes must be www-data
```
As always the test must fail first.
.footnote[
`benningm/puppet-docker_bamberg`:
[0fd2b59](https://github.com/benningm/puppet-docker_bamberg/commit/0fd2b59f96f0d8b5a9414eed7dda7337cccdd52a)
]
---
# Webserver configuration

The puppet module `jfryman-nginx` will do the configuration of nginx for us.

Again we add a dependecy on this module to our modules `metadata.json`:

&lt;pre class=&quot;console&quot;&gt;
&lt;span style=&quot;font-weight:bold;&quot;&gt;--- a/metadata.json&lt;/span&gt;
&lt;span style=&quot;font-weight:bold;&quot;&gt;+++ b/metadata.json&lt;/span&gt;
&lt;span style=&quot;color:aqua;&quot;&gt;@@ -9,7 +9,8 @@&lt;/span&gt;
   &amp;quot;issues_url&amp;quot;: &amp;quot;https://github.com/benningm/puppet-docker_bamberg/issues&amp;quot;,
   &amp;quot;dependencies&amp;quot;: [
     {&amp;quot;name&amp;quot;:&amp;quot;puppetlabs-stdlib&amp;quot;,&amp;quot;version_requirement&amp;quot;:&amp;quot;&amp;gt;= 1.0.0&amp;quot;},
&lt;span style=&quot;color:red;&quot;&gt;-    {&amp;quot;name&amp;quot;:&amp;quot;puppetlabs-vcsrepo&amp;quot;,&amp;quot;version_requirement&amp;quot;:&amp;quot;&amp;gt;= 1.3.2&amp;quot;}&lt;/span&gt;
&lt;span style=&quot;color:lime;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;    {&amp;quot;name&amp;quot;:&amp;quot;puppetlabs-vcsrepo&amp;quot;,&amp;quot;version_requirement&amp;quot;:&amp;quot;&amp;gt;= 1.3.2&amp;quot;},&lt;/span&gt;
&lt;span style=&quot;color:lime;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;    {&amp;quot;name&amp;quot;:&amp;quot;jfryman-nginx&amp;quot;,&amp;quot;version_requirement&amp;quot;:&amp;quot;&amp;gt;= 0.3.0&amp;quot;}&lt;/span&gt;
   ]
 }
&lt;/pre&gt;

For development we just install it for reasons mentioned before:

```shell
root@docker-bamberg:~# puppet module install jfryman-nginx
```
---
# Webserver configuration

Thanks to the `nginx` puppet module the configuration is easy:

```puppet
class docker_bamberg::webserver {
  require docker_bamberg::content

  class { 'nginx': }
  nginx::resource::vhost { 'docker-bamberg.de':
      www_root => '/data/htdocs',
  }
}
```
---
# Webserver configuration

Also include the webserver class in the main class:

&lt;pre class=&quot;console&quot;&gt;
&lt;span style=&quot;font-weight:bold;&quot;&gt;--- a/manifests/init.pp&lt;/span&gt;
&lt;span style=&quot;font-weight:bold;&quot;&gt;+++ b/manifests/init.pp&lt;/span&gt;
&lt;span style=&quot;color:aqua;&quot;&gt;@@ -26,4 +26,5 @@&lt;/span&gt;
 #
 class docker_bamberg {
   include docker_bamberg::content
&lt;span style=&quot;color:lime;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;  include docker_bamberg::webserver&lt;/span&gt;
 }
&lt;/pre&gt;

Apply the configuration within our development container:

```shell
root@docker-bamberg:~# puppet apply /etc/puppet/manifests/
```
---
# Webserver configuration

The test should pass now:

```shell
root@docker-bamberg:~# pherkin \
  /etc/puppet/modules/docker_bamberg/features/webserver.feature 
```
&lt;pre class=&quot;console&quot;&gt;
  Webserver for docker bamberg
    To serve the docker-bamberg.de website a webserver is required.
    The nginx webserver will be used.

    Scenario: nginx webserver must running
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;a parent process like &lt;/span&gt;^nginx:&lt;span style=&quot;color:lime;&quot;&gt; is running&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the uid of the process must be &lt;/span&gt;root
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the gid of the process must be &lt;/span&gt;root
      &lt;span style=&quot;color:lime;&quot;&gt;When &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;there are &lt;/span&gt;at least&lt;span style=&quot;color:lime;&quot;&gt; &lt;/span&gt;1&lt;span style=&quot;color:lime;&quot;&gt; child processes&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the uid of the child processes must be &lt;/span&gt;www-data
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the gid of the child processes must be &lt;/span&gt;www-data
&lt;/pre&gt;
---
# Mission accomplished!

Also our `website.feature` test should pass now:

```shell
root@docker-bamberg:~# pherkin \
  /etc/puppet/modules/docker_bamberg/features/website.feature 
```

&lt;pre class=&quot;console&quot;&gt;
  Docker Bamberg website
    The Docker Bamberg needs a website to publish presentations and
    content on the internet.

    Scenario: The Website must be accessible
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http URL &lt;/span&gt;http://docker-bamberg.de/
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http request method is &lt;/span&gt;GET
      &lt;span style=&quot;color:lime;&quot;&gt;When &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http request is sent&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http response must be &lt;/span&gt;successfull
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http response content must be like &lt;/span&gt;Docker Bamberg
&lt;/pre&gt;
---
# Rebuild the Dockerimage

Now make sure that you commited and pushed all the changes to the git repository.

Then rebuild the docker image to contain all changes we made:

```shell
$ docker built -t docker-bamberg .
```

If you now start up a container the nginx process should already be running:

```shell
$ docker run -it --rm --hostname docker-bamberg.de docker-bamberg /bin/bash
```

```shell
root@docker-bamberg:/# ps axf
  PID TTY      STAT   TIME COMMAND
    1 ?        Ss     0:00 /bin/bash /entrypoint.sh /bin/bash
  225 ?        Ss     0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.co
  226 ?        S      0:00  \_ nginx: worker process                   
  262 ?        S      0:00 /bin/bash
  263 ?        R+     0:00  \_ ps axf
```
---
class: center, middle
# Goodies
---
# Test the Dockerimage

Instead of shell you can of course just run the tests:

```shell
$ docker run -it --rm --hostname docker-bamberg.de docker-bamberg \
  pherkin /etc/puppet/modules/docker_bamberg/features/
```

.truncated-bottom[
&lt;pre class=&quot;console&quot;&gt;
&lt;span style=&quot;color:red;font-weight:bold;&quot;&gt;Warning: Config file /etc/puppet/hiera.yaml not found, using Hiera defaults&lt;/span&gt;
Notice: Compiled catalog for docker-bamberg.de in environment production in 0.92 seconds
Notice: /Stage[main]/Nginx::Service/Service[nginx]/ensure: ensure changed &#39;stopped&#39; to &#39;running&#39;
Notice: Finished catalog run in 4.81 seconds

  Docker Bamberg website
    The Docker Bamberg needs a website to publish presentations and
    content on the internet.

    Scenario: The Website must be accessible
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http URL &lt;/span&gt;http://docker-bamberg.de/
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http request method is &lt;/span&gt;GET
      &lt;span style=&quot;color:lime;&quot;&gt;When &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http request is sent&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http response must be &lt;/span&gt;successfull
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http response content must be like &lt;/span&gt;Docker Bamberg
&lt;/pre&gt;
]
---
# Monitoring a running container

You can also run the tests on a running container:

```shell
$ docker exec -it 6329f2b36bc0 \
  pherkin /etc/puppet/modules/docker_bamberg/features/
```

The output should be the same.
---
# Nagios test integration

To integrate the tests within your monitoring use the nagios-style
test output of the `check_pherkin` tool:

```shell
$ docker exec 6329f2b36bc0 \
  check_pherkin /etc/puppet/modules/docker_bamberg/features/
```

&lt;pre class=&quot;console&quot;&gt;
OK - all 4 scenarios passed
&lt;/pre&gt;

Options are identical to `pherkin` usage.

If you have a lot of tests you may consider tagging your tests
and select only certain tags with the `-t` option.
---
# Generate a HTML test report

If you need to share your test results with others a HTML report
will be very handy. Use the Html output module:

```shell
$ docker exec 6329f2b36bc0 \
  pherkin -o Html /etc/puppet/modules/docker_bamberg/features/ > report.html
```

&lt;iframe style=&quot;margin:0;padding:0;width:100%;height:300px;border-radius: 5px;border:1px solid;&quot; src=&quot;media/docker-bamberg-report.html&quot;&gt;&lt;/iframe&gt;
---
class: center, middle

# That's all folks (for now)!
---
# References

* [Markus Benning Blog](https://markusbenning.de/blog/)
* Docker-Image: puppet-base
 * DockerHub: [benningm/puppet-base](https://hub.docker.com/r/benningm/puppet-base/)
 * Github: [benningm/docker-puppet-base](https://github.com/benningm/docker-puppet-base)
* Examples
 * Github: [benningm/jekyll-docker-bamberg.de](https://github.com/benningm/jekyll-docker-bamberg.de)
 * Github: [benningm/docker-docker-bamberg](https://github.com/benningm/docker-docker-bamberg)
 * Github: [benningm/puppet-docker_bamberg](https://github.com/benningm/puppet-docker_bamberg)
* Tools
 * librarian-puppet
 * CPAN: [Test::BDD::Infrastructure](https://metacpan.org/release/Test-BDD-Infrastructure)
 * CPAN: [Test::BDD::Cucumber::Harness::Html](https://metacpan.org/release/Test-BDD-Cucumber-Harness-Html)
 * CPAN: [Test::BDD::Cucumber::Harness::Nagios](https://metacpan.org/release/Test-BDD-Cucumber-Harness-Nagios)
* Debian Packages:
 * [Markus Benning Debian Repository](https://markusbenning.de/debian/)
* This presentation, built with [remark.js](http://remarkjs.com/#1)
 * View at: [Test-Driven Infrastructure][https://markusbenning.de/slides-docker-bamberg/test-driven-infrastructure.html#1]
 * GitHub: [benningm/slides-docker-bamberg](https://github.com/benningm/slides-docker-bamberg)

    </textarea>
    <script src="remark.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>
