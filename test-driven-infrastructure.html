<!DOCTYPE html>
<html>
  <head>
    <title>Test-Driven Infrastructure</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: 400;
        margin-bottom: 0;
      }
      .remark-slide-content h1 { font-size: 3em; }
      .remark-slide-content h2 { font-size: 2em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .footnote {
        position: absolute;
        bottom: 3em;
      }
      pre.console {
        background: #002b36;
        border-radius: 5px;
        font-family: 'Ubuntu Mono';
        color: #fdf6e3;
      }
      code {
        background: #e7e8e2;
        border-radius: 5px;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-code-line-highlighted     { background-color: #373832; }
      li p { line-height: 1.25em; }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      /* Two-column layout */
      .left-column {
        color: #777;
        width: 20%;
        height: 92%;
        float: left;
      }
      .left-column h2:last-of-type, .left-column h3:last-child {
        color: #000;
      }
      .right-column {
        width: 75%;
        float: right;
        /*padding-top: 1em; */
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Test-Driven Infrastructure

with Puppet, Cucumber and Docker

by Markus Benning

---

# About me

Name: Markus Benning
TODO

---

# Agenda

1. Puppet
  * What is Puppet
  * Why Puppet?
2. Test-Driven Infrastructure
3. ...

---
class: center, middle
# Puppet
---
layout: false
.left-column[
  # Puppet
  ## What is it?
]
.right-column[
# Task: install Postfix (easy?)

Is it already installed?

```bash
$ dpkg -l postfix
```

No? Install version 3.1:

```bash
$ apt-get install postfix=3.1
```

Hum. That was for Debian, but on RedHat?

```bash
$ rpm -q postfix
$ yum install postfix=3.1
```
]

---

layout: false
.left-column[
  # Puppet
  ## What is it?
]
.right-column[
# With puppet

Write a manifest.pp file:

```puppet
package { 'postfix':
  ensure => '3.1',
}
```

then apply it:

```shell
$ puppet apply manifest.pp
```

]
---
class: center, middle
## Puppet turns config into code!
---
layout: false
.left-column[
  # Puppet
  ## What is it?
  ## Why use it?
]
.right-column[
# Turning config into code

What we get:

 * Repeatability
 * Automation
 * Agility
 * Scalability
 * Reassurance
 * Disaster Recovery
]
---
class: center, middle
# Test-Driven Infrastructure
---
# Test-Driven Development Workflow
![Default-aligned image](media/tdd-workflow.svg)
---
# Test-Driven ~~Development~~ Infrastructure
![Default-aligned image](media/tdi-workflow.svg)
---
class: center, middle
# Behavior-Driven Development
---
# BDD with Cucumber

Tests are written in gherkin:

```gherkin
Feature: Calculator
  The calculator must be able to calculate a simple addition.

  Scenario: Add a value to the buffer
    Given a new calculator instance is created
    When the buffer is set to 10
    And and the value 20 is added
    Then the buffer must be 30
```

.footnote[Cucumber Website: [Gherkin Reference](https://cucumber.io/docs/reference)]
---
# BDD with Cucumber (extended example)

```gherkin
Feature: Calculator
  The calculator must be able to calculate a simple addition.

  Scenario: Add a value to the buffer
    Given a new calculator instance is created
    When the buffer is set to <buffer>
    And and the value <value> is added
    Then the buffer must be <result>

    Examples:
    | buffer | value | result |
    | 10 | 20 | 30 |
    | 23 | 65 | 88 |
```
.footnote[Cucumber Website: [Gherkin Reference](https://cucumber.io/docs/reference)]
---
# BDD with Cucumber (no steps defined)

Execute the tests with `pherkin`:

```shell
$ pherkin features/addition.feature
```

The steps (tests) are uninplemented:

&lt;pre class=&quot;console&quot;&gt;

  Calculator
    The calculator must be able to calculate a simple addition.

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:yellow;&quot;&gt;Given a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 10&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And and the value 20 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 30&lt;/span&gt;

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:yellow;&quot;&gt;Given a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 23&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And and the value 65 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 88&lt;/span&gt;

&lt;/pre&gt;
---
# BDD with Cucumber (implement tests)

```perl
Given qr/^a new calculator instance is created$/, sub {
  use_ok('MyCalc');
  my $calc = MyCalc->new;
  isa_ok($calc, 'MyCalc');
  S->{'calc'} = $calc;
};

When qr/^the buffer is set to (\d+)$/, sub {
  S->{'calc'}->buffer($1);
};

When qr/^the value (\d+) is added$/, sub {
  S->{'calc'}->add($1);
};

Then qr/^the buffer must be (\d+)$/, sub {
  cmp_ok( S->{'calc'}->buffer, '==', $1, 'value of buffer must match');
};
```
.footnote[MetaCPAN: [Test:BDD:Cucumber](https://metacpan.org/release/Test-BDD-Cucumber), [Tutorial](https://metacpan.org/pod/distribution/Test-BDD-Cucumber/lib/Test/BDD/Cucumber/Manual/Tutorial.pod)]
---
# BDD with Cucumber (tests fail)

&lt;pre class=&quot;console&quot;&gt;

  Calculator
    The calculator must be able to calculate a simple addition.

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:red;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:red;&quot;&gt;a new calculator instance is created&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;step defined at features/addition.feature line 5.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;ok 1 - Starting to execute step: a new calculator instance is created&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;not ok 2 - use MyCalc;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   Failed test &#39;use MyCalc;&#39;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   at features/step_definitions/calc_steps.pl line 10.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#     Tried to use &#39;MyCalc&#39;.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#     Error:  Can&#39;t locate MyCalc.pm in @INC (you may need to install the MyCalc module) (@INC contains: /etc/perl /usr/local/lib/x86_64-linux-gnu/perl/5.22.1 /usr/local/share/perl/5.22.1 /usr/lib/x86_64-linux-gnu/perl5/5.22 /usr/share/perl5 /usr/lib/x86_64-linux-gnu/perl/5.22 /usr/share/perl/5.22 /usr/local/lib/site_perl /usr/lib/x86_64-linux-gnu/perl-base .) at features/step_definitions/calc_steps.pl line 10, &amp;lt;DATA&amp;gt; line 870.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;# BEGIN failed--compilation aborted at features/step_definitions/calc_steps.pl line 10, &amp;lt;DATA&amp;gt; line 870.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;not ok 3 - Test compiled&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   Failed test &#39;Test compiled&#39;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   at /usr/share/perl5/Test/BDD/Cucumber/Executor.pm line 419.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;# Can&#39;t locate object method &amp;quot;new&amp;quot; via package &amp;quot;MyCalc&amp;quot; (perhaps you forgot to load &amp;quot;MyCalc&amp;quot;?) at features/step_definitions/calc_steps.pl line 11, &amp;lt;DATA&amp;gt; line 870.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;1..3&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 10&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And the value 20 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 30&lt;/span&gt;

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:yellow;&quot;&gt;Given a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 23&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And the value 65 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 88&lt;/span&gt;

&lt;/pre&gt;
---
# BDD with Cucumber (implementation)

Implement the calculator class in perl:

```perl
package MyCalc;

use Moose;

has 'buffer' => ( is => 'rw', isa => 'Num', default => 0 );

sub add {
  my ( $self, $value ) = @_;
  return $self->buffer( $self->buffer + $value );
}

1;
```
---
# BDD with Cucumber (tests pass!)

&lt;pre class=&quot;console&quot;&gt;

  Calculator
    The calculator must be able to calculate a simple addition.

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;When &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer is set to &lt;/span&gt;10
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the value &lt;/span&gt;20&lt;span style=&quot;color:lime;&quot;&gt; is added&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer must be &lt;/span&gt;30

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;When &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer is set to &lt;/span&gt;23
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the value &lt;/span&gt;65&lt;span style=&quot;color:lime;&quot;&gt; is added&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer must be &lt;/span&gt;88

&lt;/pre&gt;
    </textarea>
    <script src="remark.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>
