<!DOCTYPE html>
<html>
  <head>
    <title>Test-Driven Infrastructure</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: 400;
        margin-bottom: 0;
      }
      .remark-slide-content h1 { font-size: 3em; }
      .remark-slide-content h2 { font-size: 2em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .footnote {
        position: absolute;
        bottom: 3em;
      }
      pre.console {
        background: #002b36;
        border-radius: 5px;
        font-family: 'Ubuntu Mono';
        color: #fdf6e3;
      }
      code {
        background: #e7e8e2;
        border-radius: 5px;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-code-line-highlighted     { background-color: #373832; }
      li p { line-height: 1.25em; }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      /* Two-column layout */
      .left-column {
        color: #777;
        width: 20%;
        height: 92%;
        float: left;
      }
      .left-column h2:last-of-type, .left-column h3:last-child {
        color: #000;
      }
      .right-column {
        width: 75%;
        float: right;
        /*padding-top: 1em; */
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Test-Driven Infrastructure

with Puppet, Cucumber and Docker

*Markus Benning*

---
layout: false
.left-column[
# Agenda
]
.right-column[
## Concepts

* Puppet
* Test-Driven Infrastructure
* Behavior-Driven Development

## Toolchain

* A toolchain for TDI

## Hands on 

* Build a simple webserver for serving a Docker Bamberg weblog

## Goodies

* Continuous Integration, Monitoring, Documentation, Checklists, Change Evidence build in!
]
---
class: center, middle
# Puppet
---
layout: false
.left-column[
  # Puppet
  ## What is it?
]
.right-column[
# Task: install Postfix (easy?)

Is it already installed?

```bash
$ dpkg -l postfix
```

No? Install version 3.1:

```bash
$ apt-get install postfix=3.1
```

Hum. That was for Debian, but on RedHat?

```bash
$ rpm -q postfix
$ yum install postfix=3.1
```
]

---

layout: false
.left-column[
  # Puppet
  ## What is it?
]
.right-column[
# With puppet

Write a manifest.pp file:

```puppet
package { 'postfix':
  ensure => '3.1',
}
```

then apply it:

```shell
$ puppet apply manifest.pp
```

]
---
class: center, middle
## Puppet turns config into code!
---
layout: false
.left-column[
  # Puppet
  ## What is it?
  ## Why use it?
]
.right-column[
# Turning config into code

What we get:

 * Repeatability
 * Automation
 * Agility
 * Scalability
 * Reassurance
 * Disaster Recovery
]
---
class: center, middle
# Test-Driven Infrastructure
---
# Test-Driven Development Workflow
![Default-aligned image](media/tdd-workflow.svg)
---
# Test-Driven ~~Development~~ Infrastructure
![Default-aligned image](media/tdi-workflow.svg)
---
class: center, middle
# Behavior-Driven Development
---
# BDD with Cucumber

Tests are written in gherkin:

```gherkin
Feature: Calculator
  The calculator must be able to calculate a simple addition.

  Scenario: Add a value to the buffer
    Given a new calculator instance is created
    When the buffer is set to 10
    And and the value 20 is added
    Then the buffer must be 30
```

.footnote[Cucumber Website: [Gherkin Reference](https://cucumber.io/docs/reference)]
---
# BDD with Cucumber (extended example)

```gherkin
Feature: Calculator
  The calculator must be able to calculate a simple addition.

  Scenario: Add a value to the buffer
    Given a new calculator instance is created
    When the buffer is set to <buffer>
    And and the value <value> is added
    Then the buffer must be <result>

    Examples:
    | buffer | value | result |
    | 10 | 20 | 30 |
    | 23 | 65 | 88 |
```
.footnote[Cucumber Website: [Gherkin Reference](https://cucumber.io/docs/reference)]
---
# BDD with Cucumber (no steps defined)

Execute the tests with `pherkin`:

```shell
$ pherkin features/addition.feature
```

The steps (tests) are uninplemented:

&lt;pre class=&quot;console&quot;&gt;

  Calculator
    The calculator must be able to calculate a simple addition.

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:yellow;&quot;&gt;Given a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 10&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And and the value 20 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 30&lt;/span&gt;

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:yellow;&quot;&gt;Given a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 23&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And and the value 65 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 88&lt;/span&gt;

&lt;/pre&gt;
---
# BDD with Cucumber (implement tests)

```perl
Given qr/^a new calculator instance is created$/, sub {
  use_ok('MyCalc');
  my $calc = MyCalc->new;
  isa_ok($calc, 'MyCalc');
  S->{'calc'} = $calc;
};

When qr/^the buffer is set to (\d+)$/, sub {
  S->{'calc'}->buffer($1);
};

When qr/^the value (\d+) is added$/, sub {
  S->{'calc'}->add($1);
};

Then qr/^the buffer must be (\d+)$/, sub {
  cmp_ok( S->{'calc'}->buffer, '==', $1, 'value of buffer must match');
};
```
.footnote[MetaCPAN: [Test:BDD:Cucumber](https://metacpan.org/release/Test-BDD-Cucumber), [Tutorial](https://metacpan.org/pod/distribution/Test-BDD-Cucumber/lib/Test/BDD/Cucumber/Manual/Tutorial.pod)]
---
# BDD with Cucumber (tests fail)

&lt;pre class=&quot;console&quot;&gt;

  Calculator
    The calculator must be able to calculate a simple addition.

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:red;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:red;&quot;&gt;a new calculator instance is created&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;step defined at features/addition.feature line 5.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;ok 1 - Starting to execute step: a new calculator instance is created&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;not ok 2 - use MyCalc;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   Failed test &#39;use MyCalc;&#39;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   at features/step_definitions/calc_steps.pl line 10.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#     Tried to use &#39;MyCalc&#39;.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#     Error:  Can&#39;t locate MyCalc.pm in @INC (you may need to install the MyCalc module) (@INC contains: /etc/perl /usr/local/lib/x86_64-linux-gnu/perl/5.22.1 /usr/local/share/perl/5.22.1 /usr/lib/x86_64-linux-gnu/perl5/5.22 /usr/share/perl5 /usr/lib/x86_64-linux-gnu/perl/5.22 /usr/share/perl/5.22 /usr/local/lib/site_perl /usr/lib/x86_64-linux-gnu/perl-base .) at features/step_definitions/calc_steps.pl line 10, &amp;lt;DATA&amp;gt; line 870.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;# BEGIN failed--compilation aborted at features/step_definitions/calc_steps.pl line 10, &amp;lt;DATA&amp;gt; line 870.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;not ok 3 - Test compiled&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   Failed test &#39;Test compiled&#39;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   at /usr/share/perl5/Test/BDD/Cucumber/Executor.pm line 419.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;# Can&#39;t locate object method &amp;quot;new&amp;quot; via package &amp;quot;MyCalc&amp;quot; (perhaps you forgot to load &amp;quot;MyCalc&amp;quot;?) at features/step_definitions/calc_steps.pl line 11, &amp;lt;DATA&amp;gt; line 870.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;1..3&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 10&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And the value 20 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 30&lt;/span&gt;

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:yellow;&quot;&gt;Given a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;When the buffer is set to 23&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And the value 65 is added&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;Then the buffer must be 88&lt;/span&gt;

&lt;/pre&gt;
---
# BDD with Cucumber (implementation)

Implement the calculator class in perl:

```perl
package MyCalc;

use Moose;

has 'buffer' => ( is => 'rw', isa => 'Num', default => 0 );

sub add {
  my ( $self, $value ) = @_;
  return $self->buffer( $self->buffer + $value );
}

1;
```
---
# BDD with Cucumber (tests pass!)

&lt;pre class=&quot;console&quot;&gt;

  Calculator
    The calculator must be able to calculate a simple addition.

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;When &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer is set to &lt;/span&gt;10
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the value &lt;/span&gt;20&lt;span style=&quot;color:lime;&quot;&gt; is added&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer must be &lt;/span&gt;30

    Scenario: Add a value to the buffer
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;a new calculator instance is created&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;When &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer is set to &lt;/span&gt;23
      &lt;span style=&quot;color:lime;&quot;&gt;And &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the value &lt;/span&gt;65&lt;span style=&quot;color:lime;&quot;&gt; is added&lt;/span&gt;
      &lt;span style=&quot;color:lime;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the buffer must be &lt;/span&gt;88

&lt;/pre&gt;
---
# BDD with Cucumber (why?)

* With BDD we get an **executable specification** which could be used for
all kind of **automated testing**.

* It is writte in gherkin a (near) **human language** everyone involved
should be able to understand.

* Therefor it could be used as a **single point of truth** across Devs,
Ops and Customers to **collaboratively work** on.

* Every change starts (red state) and ends (green state)
with the test specification. This keeps the **specification up to date**.
---
class: center, middle
# The Toolchain
---
# The Toolchain

## Environment

* **Docker** to provide a virtual environment
* The `benningm/puppet-base` image. Debian environment with our toolchain

## Configuration

* **Puppet** to apply configuration as defined in manifests
* **librarian-puppet** to install our puppet module and its dependecies

## Testing

* **Test::BDD::Cucumber** a perl implementation of Cucumber
* **Test::BDD::Infrastructure** collection of step definitions for TDI
* **T:B:C:Harness::Html** to generate HTML test reports
* **T:B:C:Harness::Nagios** to execute tests for nagios
---
class: center, middle
# Hands on
Build a simple weblog webserver
---
# Create an empty puppet module

Puppet has command for generating a module skeleton:

```shell
$ puppet module generate benningm-docker_bamberg
```

Push it to your git repository server:

```shell
$ cd benningm-docker_bamberg
$ git init
$ git add .
$ git commit -a -m 'check in of empty module skeleton'
$ git remote add origin git@github.com:benningm/puppet-docker_bamberg.git
$ git push -u origin master
```

The main class of your puppet module is defined in `manifests/init.pp`.
Edit the description and documentation in this file and commit it:

```shell
$ git commit -a -m 'add description and usage of module'
```
.footnote[
`benningm/puppet-docker_bamberg`:
[4c1d0d6](https://github.com/benningm/puppet-docker_bamberg/commit/4c1d0d6369db5bfe501ae061bfe0769c468a6907)
, [6c89882](https://github.com/benningm/puppet-docker_bamberg/commit/6c89882f1186ae14558cc505cd93cab2b647e8e1)
]
---
# Build the docker image (Dockerfile)

Fetch our puppet module and apply the its configuration:

```Dockerfile
FROM benningm/puppet-base:latest
MAINTAINER Markus Benning <ich@markusbenning.de>

ADD Puppetfile /etc/puppet/Puppetfile
RUN cd /etc/puppet && librarian-puppet install --verbose

ADD manifest.pp /etc/puppet/manifests/docker_bamberg.pp
RUN /usr/local/bin/puppet-apply-wrapper /etc/puppet/manifests

EXPOSE 80
```
The `puppet-apply-wrapper` script is just a wrapper around `puppet apply`
with correct return values to indicate failure/success.

We still have to create `Puppetfile` which configures `librarian-puppet`
and `manifest.pp` for puppet.
---
# Build the docker image (Puppetfile)

```Puppetfile
forge "https://forgeapi.puppetlabs.com"

mod "benningm/docker_bamberg",
  :git => "https://github.com/benningm/puppet-docker_bamberg.git"

```

The first line tells `librarian-puppet` to fetch dependecies from the
Puppet Forge.

The second line installs our puppet module from our git repository.
---
# Build the docker image (manifest.pp)

```puppet
class { 'docker_bamberg':
}
```
The `manifest.pp` file just tells puppet to execute the class of our
module which has no parameters.

Create a git repository and push everything to your repository server.

.footnote[
`benningm/docker-docker-bamberg`:
[40a1dae](https://github.com/benningm/docker-docker-bamberg/commit/40a1daeba7dc0c93a04ceccf40f47cfa33537d83)
]
---
# Build the docker image (do it!)

To build the docker image:

```shell
$ docker built -t docker-bamberg .
```

And start a container of it:

```shell
$ docker run -it --rm docker-bamberg /bin/bash
```

&lt;pre class=&quot;console&quot;&gt;
Notice: Compiled catalog for 3e6c1f1c68d9.lan in environment production in 0.01 seconds
Notice: Finished catalog run in 0.01 seconds
root@3e6c1f1c68d9:/# ps axf
  PID TTY      STAT   TIME COMMAND
    1 ?        Ss     0:00 /bin/bash /entrypoint.sh /bin/bash
  114 ?        S      0:00 /bin/bash
  119 ?        R+     0:00  \_ ps axf
root@3e6c1f1c68d9:/# exit
[ &lt;span style=&quot;color:lime;&quot;&gt;ok&lt;/span&gt; ] Asking all remaining processes to terminate...done.
[ &lt;span style=&quot;color:lime;&quot;&gt;ok&lt;/span&gt; ] All processes ended within 1 seconds...done.
&lt;/pre&gt;
---
# Start a development container

Now we start a container for development. We mount our local git directory
as a volume into the container. This way we can edit the puppet module
with our favorite editor and all tools available on our development box
and apply the changes within the container.

```shell
$ docker run -it --rm \
  --hostname docker-bamberg.de \
  -v ~/development/puppet-docker_bamberg:/etc/puppet/modules/docker_bamberg \
  docker-bamberg /bin/bash
```

&lt;pre class=&quot;console&quot;&gt;
Notice: Compiled catalog for docker-bamberg.de in environment production in 0.02 seconds
Notice: Finished catalog run in 0.09 seconds
root@docker-bamberg:/#
&lt;/pre&gt;

Everytime we change something we can apply the changes with:

```shell
root@docker-bamberg:/# puppet apply /etc/puppet/manifests/
```

&lt;pre class=&quot;console&quot;&gt;
Notice: Compiled catalog for docker-bamberg.de in environment production in 0.02 seconds
Notice: Finished catalog run in 0.06 seconds
&lt;/pre&gt;
---
# Define our mission goal (1/2)

Befor we start with configuration details we want to specify what
we want to achieve.

Create a first feature `features/website.feature`:

```gherkin
Feature: Docker Bamberg website
  The Docker Bamberg needs a website to publish presentations and
  content on the internet.

  Scenario: The Website must be accessible
    Given the http URL http://docker-bamberg.de/
    Given the http request method is GET
    When the http request is sent
    Then the http response must be successfull
    And the http response content must be like Docker Bamberg
```
---
# Define our mission goal (2/2)

To load the Test::BDD::Infrastructure step definitions.
Create `features/step_definitions/00use_steps.pl`:

```perl
#!perl
use Test::BDD::Infrastructure;
```
.footnote[
`benningm/puppet-docker_bamberg`:
[8cdf38a](https://github.com/benningm/puppet-docker_bamberg/commit/8cdf38a9990b3e1c0292739a03a659253fbcd795)
]
---
# Execute specification

```shell
root@docker-bamberg:/# pherkin /etc/puppet/modules/docker_bamberg/features/website.feature 
```

&lt;pre class=&quot;console&quot;&gt;
  Docker Bamberg website
    The Docker Bamberg needs a website to publish presentations and
    content on the internet.

    Scenario: The Website must be accessible
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http URL &lt;/span&gt;http://docker-bamberg.de/
      &lt;span style=&quot;color:lime;&quot;&gt;Given &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http request method is &lt;/span&gt;GET
      &lt;span style=&quot;color:lime;&quot;&gt;When &lt;/span&gt;&lt;span style=&quot;color:lime;&quot;&gt;the http request is sent&lt;/span&gt;
      &lt;span style=&quot;color:red;&quot;&gt;Then &lt;/span&gt;&lt;span style=&quot;color:red;&quot;&gt;the http response must be &lt;/span&gt;successfull
        &lt;span style=&quot;color:red;&quot;&gt;step defined at /etc/puppet/modules/docker_bamberg/features/website.feature line 9.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;ok 1 - Starting to execute step: the http response must be successfull&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;# response code is 500 Can&#39;t connect to docker-bamberg.de:80&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;not ok 2 - successfull http response&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   Failed test &#39;successfull http response&#39;&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;#   at /usr/share/perl5/Test/BDD/Infrastructure/HTTP.pm line 67.&lt;/span&gt;
        &lt;span style=&quot;color:red;&quot;&gt;1..2&lt;/span&gt;
      &lt;span style=&quot;color:yellow;&quot;&gt;And the http response content must be like Docker Bamberg&lt;/span&gt;
&lt;/pre&gt;

    </textarea>
    <script src="remark.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>
